# Sliding Window vs Token Bucket (Deque ê¸°ë°˜ êµ¬í˜„)

## 1. ê°œìš”

`Sliding Window`ì™€ `Token Bucket`ì€ ëª¨ë‘ **Rate Limiting (ìš”ì²­ ì†ë„ ì œí•œ)** ì•Œê³ ë¦¬ì¦˜ì´ë‹¤.  
ë‘˜ ë‹¤ â€œì¼ì • ì‹œê°„ ë‚´ í—ˆìš© ê°€ëŠ¥í•œ ìš”ì²­ ìˆ˜â€ë¥¼ ì œì–´í•˜ì§€ë§Œ, ì‹œê°„ ì²˜ë¦¬ ë°©ì‹ì´ ë‹¤ë¥´ë‹¤.

ì´ ë¬¸ì„œì—ì„œëŠ” **Deque ê¸°ë°˜ Sliding Window** êµ¬í˜„ì„ ê¸°ì¤€ìœ¼ë¡œ, **Token Bucket**ê³¼ì˜ êµ¬ì¡°ì  ì°¨ì´ë¥¼ ë¹„êµí•œë‹¤.

> Sliding WindowëŠ” ìš”ì²­ ë¡œê·¸ ê¸°ë°˜ì˜ ì •ë°€ ì œì–´ ë°©ì‹ì´ê³ ,  
> Token Bucketì€ ì´ë¥¼ ì‹œê°„ ì—°ì† ëª¨ë¸ë¡œ ê·¼ì‚¬í™”í•œ íš¨ìœ¨ì  ë°©ì‹ì´ë‹¤.

---

## 2. Sliding Window (Deque ê¸°ë°˜)

### âœ… ì½”ë“œ ì˜ˆì‹œ

```java
public RateDecision tryRequest(String key, long nowNanoSec) {
    // keyë³„ ìš”ì²­ ë¡œê·¸ ê´€ë¦¬
    Deque<Long> deque = buckets.computeIfAbsent(key, k -> new ConcurrentLinkedDeque<>());

    // 1ì´ˆ ì´ì „ ìš”ì²­ ì œê±°
    long before1Sec = nowNanoSec - windowNanoSec; // windowNanoSec = 1_000_000_000 (1ì´ˆ)
    Long first;
    while ((first = deque.peekFirst()) != null && first < before1Sec) {
        deque.pollFirst(); // ì˜¤ë˜ëœ ìš”ì²­ ì œê±°
    }

    // ìµœê·¼ 1ì´ˆ ë‚´ ìš”ì²­ì´ limit ì´ìƒì´ë©´ ì°¨ë‹¨
    if (deque.size() >= limit) {
        Long firstRequestTime = deque.peekFirst();
        if (firstRequestTime == null) {
            return RateDecision.blocked(windowNanoSec);
        }
        long retryTime = (firstRequestTime + windowNanoSec) - nowNanoSec;
        return RateDecision.blocked(retryTime);
    }

    // ìš”ì²­ í—ˆìš© ì‹œ í˜„ì¬ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    deque.addLast(nowNanoSec);
    return RateDecision.allowed(limit - deque.size());
}
```

ğŸ“Š **ë™ì‘ ì›ë¦¬**
1. ê° key(IP, user ë“±)ì— ëŒ€í•´ ìµœê·¼ 1ì´ˆê°„ ìš”ì²­ ì‹œê°ì„ Dequeì— ì €ì¥í•œë‹¤.
2. ìƒˆ ìš”ì²­ì´ ì˜¤ë©´ 1ì´ˆ ì´ì „ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ëŠ” ì œê±°ëœë‹¤.
3. Dequeì˜ í¬ê¸°ê°€ `limit`ë³´ë‹¤ í¬ë©´ ê±°ì ˆ, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ í—ˆìš©í•œë‹¤.
4. `retryTime`ì€ ë‹¤ìŒ ìš”ì²­ì´ í—ˆìš© ê°€ëŠ¥í•œ ì‹œì (ê°€ì¥ ì˜¤ë˜ëœ ìš”ì²­ + 1ì´ˆ)ìœ¼ë¡œ ê³„ì‚°ëœë‹¤.

ğŸ‘‰ ì´ ë°©ì‹ì€ ì–´ë–¤ ì—°ì†ëœ 1ì´ˆ êµ¬ê°„ì—ì„œë„ `limit`ì„ ë„˜ì§€ ì•Šìœ¼ë¯€ë¡œ **ê²½ê³„ ë²„ìŠ¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.**

---

## 3. Token Bucket

```java
// ê°œë…ì  í‘œí˜„
// tokens = min(capacity, tokens + elapsedTime * refillPerSec)
```

- ì‹œê°„ì— ë”°ë¼ í† í°ì´ ì—°ì†ì ìœ¼ë¡œ ì±„ì›Œì§„ë‹¤(refill).
- ìš”ì²­ë§ˆë‹¤ í† í°ì„ 1ê°œì”© ì†Œëª¨í•˜ë©°, ì—†ìœ¼ë©´ ê±°ì ˆëœë‹¤.
- `nanosPerToken` ë‹¨ìœ„ë¡œ ë¦¬í•„ ì£¼ê¸°ë¥¼ ê³„ì‚°í•´ **ë‚˜ë…¸ì´ˆ ë‹¨ìœ„ ì •ë°€ ì œì–´**ê°€ ê°€ëŠ¥í•˜ë‹¤.

ğŸ“Š **íŠ¹ì§•**
- ì‹œê°„ì€ **ì—°ì†ì (Continuous)** ìœ¼ë¡œ íë¦„.
- ìš”ì²­ì´ ì—†ì–´ë„ ë‚´ë¶€ ìƒíƒœê°€ ì‹œê°„ì— ë”°ë¼ ìì—°ìŠ¤ëŸ½ê²Œ ë³µêµ¬ëœë‹¤.
- Sliding Windowë³´ë‹¤ ì •í™•ë„ëŠ” ì•½ê°„ ë‚®ì§€ë§Œ ì„±ëŠ¥ì€ O(1).

---

## 4. ë‘ ì•Œê³ ë¦¬ì¦˜ì˜ ê´€ê³„

| í•­ëª© | Sliding Window (Deque ê¸°ë°˜) | Token Bucket |
|------|-----------------------------|---------------|
| ì‹œê°„ ëª¨ë¸ | ì´ì‚°ì  (ìš”ì²­ ë‹¨ìœ„) | ì—°ì†ì  (ì‹œê°„ ë‹¨ìœ„) |
| ìƒíƒœ ê´€ë¦¬ | ìš”ì²­ ë¡œê·¸(Deque) | ë‚¨ì€ í† í° ìˆ˜ |
| ì—…ë°ì´íŠ¸ ì‹œì  | ìš”ì²­ ë°œìƒ ì‹œ | ìš”ì²­ ë˜ëŠ” ì‹œê°„ ê²½ê³¼ ì‹œì  |
| ì •í™•ë„ | ìµœê³  (ëª¨ë“  êµ¬ê°„ ì •í™• ì œì–´) | ê·¼ì‚¬ (í‰ê· ì ìœ¼ë¡œ ë™ì¼) |
| ì²˜ë¦¬ ë¹„ìš© | O(n) | O(1) |
| ë²„ìŠ¤íŠ¸ í—ˆìš© | ì—†ìŒ | capacity í•œë„ ë‚´ í—ˆìš© |

> **Token Bucketì€ Sliding Windowì˜ í‰ê·  ë™ì‘ì„ ìˆ˜í•™ì ìœ¼ë¡œ ê·¼ì‚¬í™”í•œ ëª¨ë¸**ì´ë‹¤.  
> ì¦‰, ì •í™•ë„ëŠ” ì•½ê°„ ì¤„ì´ë˜, ì—°ì‚° ë¹„ìš©ì„ ë‚®ì¶”ê³  ì—°ì†ì  íë¦„ìœ¼ë¡œ íš¨ìœ¨ì„ ë†’ì¸ë‹¤.

---

## 5. ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°

### ğŸªŸ Sliding Window (Deque ê¸°ë°˜)
> â€œì •í™•í•œ íšŒì „ë¬¸ ì‹œìŠ¤í…œâ€  
> â†’ ëª¨ë“  ìš”ì²­ ì‹œê°ì„ ê¸°ë¡í•˜ê³ , 1ì´ˆê°€ ì§€ë‚˜ë©´ í•´ë‹¹ ìš”ì²­ì„ ì œê±°.  
> â†’ í•­ìƒ ìµœê·¼ 1ì´ˆ ë™ì•ˆì˜ ìš”ì²­ ê°œìˆ˜ë§Œ ìœ íš¨í•˜ê²Œ ìœ ì§€.

### ğŸª£ Token Bucket
> â€œë¬¼íƒ±í¬ ëª¨ë¸â€  
> â†’ ì´ˆë‹¹ ì¼ì •ëŸ‰ì˜ ë¬¼(í† í°)ì´ ì±„ì›Œì§€ê³ , ìš”ì²­ë§ˆë‹¤ í•œ ì»µì”© ì‚¬ìš©.  
> â†’ íƒ±í¬ ìš©ëŸ‰(capacity)ë§Œí¼ ìˆœê°„ì ì¸ í­ì£¼ë¥¼ í¡ìˆ˜í•  ìˆ˜ ìˆìŒ.

---

## 6. ì‹œê°ì  ë¹„êµ (ê°œë…)

```
Sliding Window (Deque): [â– â– â– â– â– â– â– â– â– â– ] â† ìµœê·¼ 1ì´ˆ ìš”ì²­ ë¡œê·¸ (ì •í™•)
Token Bucket:           â”€â”€â”€â”€â”€â”€â”€â”€â–´â”€â”€â”€â”€â”€â”€â”€â”€ â† ì‹œê°„ ê²½ê³¼ì— ë”°ë¼ í† í°ì´ ì—°ì†ì ìœ¼ë¡œ ì±„ì›Œì§ (ê·¼ì‚¬)
```

- Sliding WindowëŠ” **ìš”ì²­ ë°œìƒ ì‹œì  ê¸°ì¤€**ìœ¼ë¡œ íŒë‹¨ â†’ ì •í™•í•˜ì§€ë§Œ ì—°ì‚° ë¹„ìš© ìˆìŒ.
- Token Bucketì€ **ì‹œê°„ íë¦„ì— ë”°ë¼ ìì—° ë³µêµ¬** â†’ íš¨ìœ¨ì ì´ê³  ë¶€ë“œëŸ¬ìš´ ì œì–´.

---

## 7. í•µì‹¬ ë¹„êµ ìš”ì•½

| í•­ëª© | Sliding Window (Deque) | Token Bucket |
|------|------------------------|---------------|
| ì •í™•ë„ | âœ… ë§¤ìš° ì •í™• | âš™ï¸ í‰ê·  ê·¼ì‚¬ |
| ì„±ëŠ¥ | âš™ï¸ ëŠë¦¼ (O(n)) | âš¡ ë¹ ë¦„ (O(1)) |
| ë²„ìŠ¤íŠ¸ í—ˆìš© | âŒ ì—†ìŒ | âœ… ê°€ëŠ¥ (capacityë§Œí¼) |
| êµ¬í˜„ ë³µì¡ë„ | ê°„ë‹¨ | ì¡°ê¸ˆ ë” ë³µì¡ |
| ëŒ€í‘œ êµ¬í˜„ | Deque ê¸°ë°˜ ë¡œê·¸ ê´€ë¦¬ | nanosPerToken ê¸°ë°˜ ìˆ˜ì‹ |

---

## âœ… ê²°ë¡ 
> - ë„¤ Deque ê¸°ë°˜ Sliding Window êµ¬í˜„ì€ **ê°€ì¥ ì •í™•í•œ ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ… ë°©ì‹**ìœ¼ë¡œ, ê²½ê³„ ë²„ìŠ¤íŠ¸ê°€ ì—†ë‹¤.  
> - Token Bucketì€ ì´ë¥¼ ì‹œê°„ ê¸°ë°˜ ëª¨ë¸ë¡œ ê·¼ì‚¬í•˜ì—¬ **O(1)** ì„±ëŠ¥ì„ ë‹¬ì„±í•˜ë©°, ì•½ê°„ì˜ ë²„ìŠ¤íŠ¸ë¥¼ í—ˆìš©í•œë‹¤.  
> - ë‘ ë°©ì‹ ëª¨ë‘ ëª©ì ì€ ê°™ê³ , **ì •í™•ë„ vs íš¨ìœ¨ì„±ì˜ íŠ¸ë ˆì´ë“œì˜¤í”„** ê´€ê³„ì— ìˆë‹¤.

